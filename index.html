<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Search Products</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f5f5f5; margin: 0; padding: 40px 20px; display: flex; flex-direction: column; align-items: center; }
    h1 { font-size: 2.5rem; color: #333; margin-bottom: 20px; }
    #searchBox { padding: 12px 20px; font-size: 18px; border: 2px solid #ccc; border-radius: 10px; width: 90%; max-width: 500px; margin-bottom: 30px; }
    .product-list { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; width: 100%; max-width: 1200px; }
    .product { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); flex: 1 1 280px; max-width: 280px; text-align: center; display: flex; flex-direction: column; justify-content: space-between; }
    .product img { width: 100%; height: auto; aspect-ratio: 1 / 1; object-fit: cover; margin-bottom: 15px; border-radius: 8px; }
    .buy-btn { background: #ff4747; color: #fff; padding: 10px 15px; text-decoration: none; border-radius: 5px; display: inline-block; font-weight: bold; margin-top: 10px; }
    .status-message { font-size: 1.1rem; margin-top: 20px; color: #555; }
    .status-message.error { color: #d9534f; }
    #loadMore { margin: 20px; padding: 10px 20px; font-size: 16px; border: none; border-radius: 5px; background: #007bff; color: #fff; cursor: pointer; }
    #loadMore:disabled { background: #ccc; cursor: not-allowed; }
  </style>
  <script src="https://unpkg.com/papaparse@5.3.1/papaparse.min.js"></script>
</head>
<body>
  <h1>Find Your Product</h1>
  <input type="text" id="searchBox" placeholder="Search by code or name..." aria-label="Search by code or name" disabled />
  <div id="productContainer" class="product-list"></div>
  <div id="status"></div>
  <button id="loadMore" style="display:none;">Load More</button>

  <script>
    // --- CONFIGURATION & CONSTANTS ---
    const pubId = '2PACX-1vS9Yg6etFwOX1L-t2lnOX08ODcj6Z4xnPCCfuqMkZLrtNknP1jNThnvh64s96eTN6hbOq_aP0NBnOSW';
    const csvURL = `https://docs.google.com/spreadsheets/d/e/${pubId}/pub?output=csv`;
    const CSV_HEADERS = {
      NAME: 'Name',
      CODE: 'Product Code',
      IMAGE_URL: 'Image URL',
      LINK: 'AliExpress Link'
    };
    const PAGE_SIZE = 20;
    const DEBOUNCE_DELAY = 300; // milliseconds

    // --- STATE ---
    let allProducts = [];
    let filteredProducts = [];
    let currentPageIndex = 0;

    // --- DOM ELEMENTS ---
    const searchInput = document.getElementById('searchBox');
    const productContainer = document.getElementById('productContainer');
    const statusDiv = document.getElementById('status');
    const loadMoreBtn = document.getElementById('loadMore');

    // --- UTILITY FUNCTIONS ---
    const debounce = (func, delay) => {
      let timeoutId;
      return (...args) => {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => func.apply(this, args), delay);
      };
    };

    const showStatus = (message, isError = false) => {
        statusDiv.innerHTML = `<p class="status-message ${isError ? 'error' : ''}">${message}</p>`;
    };
    
    // --- CORE LOGIC ---
    const renderProducts = (productsToRender) => {
        const fragment = document.createDocumentFragment();
        productsToRender.forEach(item => {
            const card = document.createElement('div');
            card.className = 'product';

            const title = document.createElement('h3');
            title.textContent = item[CSV_HEADERS.NAME] || 'Unnamed Product';

            const img = document.createElement('img');
            img.src = item[CSV_HEADERS.IMAGE_URL] || '';
            img.alt = item[CSV_HEADERS.NAME] || 'Product Image';
            img.onerror = () => { img.src = 'https://via.placeholder.com/280x280.png?text=Image+Not+Found'; };
            
            const link = document.createElement('a');
            link.className = 'buy-btn';
            link.href = item[CSV_HEADERS.LINK] || '#';
            link.target = '_blank';
            link.rel = 'noopener noreferrer';
            link.textContent = 'Buy on AliExpress';

            card.append(title, img, link);
            fragment.appendChild(card);
        });
        productContainer.appendChild(fragment);
    };
    
    const loadMoreProducts = () => {
        loadMoreBtn.disabled = true;
        const pageSlice = filteredProducts.slice(currentPageIndex, currentPageIndex + PAGE_SIZE);
        renderProducts(pageSlice);
        currentPageIndex += pageSlice.length;
        loadMoreBtn.style.display = currentPageIndex < filteredProducts.length ? 'block' : 'none';
        loadMoreBtn.disabled = false;
    };
    
    const performSearch = (term) => {
        const searchTerm = term.trim().toUpperCase();
        productContainer.innerHTML = '';
        statusDiv.innerHTML = '';
        currentPageIndex = 0;
        
        filteredProducts = searchTerm ? allProducts.filter(item => {
            const code = (item[CSV_HEADERS.CODE] || '').toUpperCase();
            const name = (item[CSV_HEADERS.NAME] || '').toUpperCase();
            return code.includes(searchTerm) || name.includes(searchTerm);
        }) : [...allProducts]; // If no term, show all products
        
        if (filteredProducts.length > 0) {
            loadMoreProducts();
        } else {
            showStatus(`No product found for: <strong>${term}</strong>`, true);
            loadMoreBtn.style.display = 'none';
        }
    };
    
    const debouncedSearch = debounce(performSearch, DEBOUNCE_DELAY);

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        showStatus('Loading products...');
        Papa.parse(csvURL, {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: (results) => {
                allProducts = results.data;
                searchInput.disabled = false;
                performSearch(''); // Perform initial load of all products
            },
            error: (err) => {
                showStatus(`Error loading products: ${err.message}`, true);
            }
        });
    });

    // --- EVENT LISTENERS ---
    searchInput.addEventListener('input', (e) => {
        debouncedSearch(e.target.value);
    });
    
    loadMoreBtn.addEventListener('click', loadMoreProducts);
  </script>
</body>
</html>
